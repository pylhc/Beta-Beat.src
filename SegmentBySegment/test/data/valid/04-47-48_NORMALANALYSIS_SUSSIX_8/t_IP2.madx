title, "V6.5: new IR3/7, moved Q3 in IR1/2/5/8 -  March 2004" ;

 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db5";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.503 db";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.5/toolkit lt";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/V6.500/ ds";
 system,"ln -fns /afs/cern.ch/eng/lhc/optics/ATS_V6.503 ats"; ! To allow to use ATS optics




 option, -echo, -info,  warn;
 call,   file = "db/as-built/V6.5.seq";
!call,   file = "db/as-built/V6.5.inj.str";
call,  file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//modifiers.madx";
call, file = "/afs/cern.ch/eng/lhc/optics/V6.503//install_additional_elements.madx";

!call, file= "/nfs/cs-ccr-nfs4/lhc_data/OP_DATA/Betabeat/Extractions/str_inj.str";



! temporaery compensation of wrong sign in LSA
!temp = (-1 * kq4.lr7);
!kq4.lr7 := temp;

beam, particle = proton, sequence=LHCB1, energy = 450.0, bv=1;
beam, particle = proton, sequence=LHCB2, energy = 450.0, bv=-1;





seqedit, sequence=LHCB1; 
flatten;
install, element=BGI,class=MARKER,at=real;
cycle, start=MSIA.EXIT.B1;
endedit;


seqedit, sequence=LHCB1; 
flatten;
install, element=BGI_B1,class=MARKER,at=6794.45142;
endedit;


seqedit, sequence=LHCB2; 
flatten;
install, element=BGI_B2,class=MARKER,at=13255.4495;
endedit;

use, period=LHCB1;
select, flag=twiss, clear;
select, flag=twiss, range=BPM.14R2.B1;
select, flag=twiss, range=BPM.10L2.B1, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, wx, phix, wy, phiy;
twiss, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//StartPoint.twiss";

!use, period=LHCB1;
!select, flag=twiss, clear;
!select, flag=twiss, range=BPM.14R2.B1, column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
!twiss, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//EndPoint.twiss";


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!mathing
!call, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//matchjob4_IP2_sbs.madx";
!!!!!!!!!!! end matching



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! normal propogation


!!
!!  Start at the first BPM
!!

seqedit, sequence=LHCB1; 
cycle, start=BPM.10L2.B1;
endedit;



!!
!! Save initial beta in beta0 variable
!!

use, period=LHCB1, range=BPM.10L2.B1/BPM.10L2.B1;  ! Just the starting element for speed
savebeta,label=b0, place=BPM.10L2.B1;
twiss ,chrom, betx=28.583978033, alfx=0.168754660016, bety=118.52421222, alfy=-1.51598705061,dx=0,dy=0,dpx=0,dpy=0, wx=0, phix=0, wy=0, phiy=0;

!!
!!!! Matching for coupling initial cond, R matrix
!!

select, flag=twiss, clear;
select, flag=twiss, pattern=BPM ,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, wx, phix, wy, phiy;

MATCH,USE_MACRO;
VARY, name=ir11, step=0.00001;
VARY, name=ir12, step=0.00001;
VARY, name=ir21, step=0.00001;
VARY, name=ir22, step=0.00001;

M1: MACRO={  
    savebeta,label=b1,place=BPM.10L2.B1;  ! This will update b1 with all the betas and coupling input
    twiss,beta0=b0, chrom, R11=ir11,R12=ir12,R21=ir21,R22=ir22,file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2.dat";
    system, "/usr/bin/python /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//getfterms_0.3.py -p /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8// -l IP2 -f 1 -m _free";
    call, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//initvals.dat";
}

 CONSTRAINT, EXPR= f1001r= 0.190470061342;
 CONSTRAINT, EXPR= f1001i= 0.253259061319;
 CONSTRAINT, EXPR= f1010r= 0.028565130825;
 CONSTRAINT, EXPR= f1010i= 0.00729903572413;

    lmdif, TOLERANCE=1.0E-6;
ENDMATCH;




!use, period=LHCB1, range=BPM.10L2.B1/BPM.14R2.B1;
!select, flag=twiss, clear;
!select, flag=twiss, class=quadrupole;
!select, flag=twiss, class=monitor;
!select, flag=twiss, class=rcollimator;
!select, flag=twiss, class=marker;
!select, flag=twiss, class=tkicker;
!select, flag=twiss, class=instrument,column=name,s,L, K1l;
!twiss, betx=28.583978033, alfx=0.168754660016, bety=118.52421222, alfy=-1.51598705061,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2_nom.dat";

 

use, period=LHCB1, range=BPM.10L2.B1/BPM.14R2.B1;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=rbend;
select, flag=twiss, class=tkicker;
select,flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy, L,K1l,wx,phix,wy,phiy;


twiss, beta0=b1, chrom, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2.dat";

!
! Write here some correction
!

twiss, beta0=b1, chrom, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2_cor.dat";

system, "/usr/bin/python /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//getfterms_0.3.py -p /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8// -l IP2 -e /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/input/04-47-48_NORMALANALYSIS_SUSSIX_8/ -s BPM.10L2.B1 -m _free";


!
! Please remove the correction if you want the rest to make sense
!


twiss, beta0=b1, betx=28.583978033+0.669407113875, bety=118.52421222+1.68376186268, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.b+.dat";
twiss, beta0=b1, betx=28.583978033-0.669407113875, bety=118.52421222-1.68376186268, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.b-.dat";
twiss, beta0=b1, alfx=0.168754660016+0.0140450691042, alfy=-1.51598705061+0.0229539257186, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.a+.dat";
twiss, beta0=b1, alfx=0.168754660016-0.0140450691042, alfy=-1.51598705061-0.0229539257186, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.a-.dat";
twiss, beta0=b1, dx=0+0,dy=0+0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.d+.dat";
twiss, beta0=b1, dx=0-0,dy=0-0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.d-.dat";


!!!!!! errors coupling max

MATCH,USE_MACRO;
VARY, name=ir11, step=0.00001;
VARY, name=ir12, step=0.00001;
VARY, name=ir21, step=0.00001;
VARY, name=ir22, step=0.00001;

M1: MACRO={  
    savebeta,label=b1,place=BPM.10L2.B1;  ! This will update b1 with all the betas and coupling input
    twiss,beta0=b0, chrom, R11=ir11,R12=ir12,R21=ir21,R22=ir22,file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2.dat";
    system, "/usr/bin/python /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//getfterms_0.3.py -p /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8// -l IP2  -e /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/input/04-47-48_NORMALANALYSIS_SUSSIX_8/ -s BPM.10L2.B1 -f 1 -m _free";
    call, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//initvals.dat";
}

 CONSTRAINT, EXPR= f1001r= 0.194639463174;
 CONSTRAINT, EXPR= f1001i= 0.257428463151;
 CONSTRAINT, EXPR= f1010r= 0.0327345326573;
 CONSTRAINT, EXPR= f1010i= 0.0114684375565;

    lmdif, TOLERANCE=1.0E-6;
ENDMATCH;

twiss, beta0=b1, chrom, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_c_max.dat";


!!!!!! errors coupling min

MATCH,USE_MACRO;
VARY, name=ir11, step=0.00001;
VARY, name=ir12, step=0.00001;
VARY, name=ir21, step=0.00001;
VARY, name=ir22, step=0.00001;

M1: MACRO={  
    savebeta,label=b1,place=BPM.10L2.B1;  ! This will update b1 with all the betas and coupling input
    twiss,beta0=b0, chrom, R11=ir11,R12=ir12,R21=ir21,R22=ir22,file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2.dat";
    system, "/usr/bin/python /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//getfterms_0.3.py -p /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8// -l IP2  -e /home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/input/04-47-48_NORMALANALYSIS_SUSSIX_8/ -s BPM.10L2.B1 -f 1 -m _free";
    call, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//initvals.dat";
}

 CONSTRAINT, EXPR= f1001r= 0.18630065951;
 CONSTRAINT, EXPR= f1001i= 0.249089659487;
 CONSTRAINT, EXPR= f1010r= 0.0243957289927;
 CONSTRAINT, EXPR= f1010i= 0.0031296338918;

    lmdif, TOLERANCE=1.0E-6;
ENDMATCH;

twiss, beta0=b1, chrom, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_c_min.dat";


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! back propagation


seqedit, sequence=LHCB1; 
cycle, start=BPM.14R2.B1;
flatten;reflect; ! reverse command
endedit;

use, period=LHCB1, range=BPM.14R2.B1/BPM.10L2.B1;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=rbend;
select,flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;
twiss, betx=183.96582763, alfx=2.58909820854, bety=29.2406669251, alfy=-0.929451923722, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2_nom_back.dat";

 

use, period=LHCB1, range=BPM.14R2.B1/BPM.10L2.B1;
select, flag=twiss, clear;
select, flag=twiss, class=quadrupole;
select, flag=twiss, class=monitor;
select, flag=twiss, class=rcollimator;
select, flag=twiss, class=marker;
select, flag=twiss, class=tkicker;
select, flag=twiss, class=rbend;
select,flag=twiss,pattern="XRP";
select, flag=twiss, class=instrument,column=name,s,betx,alfx,bety,alfy,mux,muy, dx, r11,r12, r22,r21, x,y,dx,dy,dpx,dpy;



twiss, betx=183.96582763, alfx=2.58909820854, bety=29.2406669251, alfy=-0.929451923722,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2_back.dat";
twiss, betx=183.96582763, alfx=2.58909820854, bety=29.2406669251, alfy=-0.929451923722,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss_IP2_play_back.dat";
twiss, betx=183.96582763+5.28693069255, alfx=2.58909820854, bety=29.2406669251+0.668441838454, alfy=-0.929451923722,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.b+_back.dat";
twiss, betx=183.96582763-5.28693069255, alfx=2.58909820854, bety=29.2406669251-0.668441838454, alfy=-0.929451923722,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.b-_back.dat";
twiss, betx=183.96582763, alfx=2.58909820854+0.0762789454104, bety=29.2406669251, alfy=-0.929451923722+0.0182396233611,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.a+_back.dat";
twiss, betx=183.96582763, alfx=2.58909820854-0.0762789454104, bety=29.2406669251, alfy=-0.929451923722-0.0182396233611,dx=0,dy=0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.a-_back.dat";
twiss, betx=183.96582763, alfx=2.58909820854, bety=29.2406669251, alfy=-0.929451923722,dx=0+0,dy=0+0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.d+_back.dat";
twiss, betx=183.96582763, alfx=2.58909820854, bety=29.2406669251, alfy=-0.929451923722,dx=0-0,dy=0-0,dpx=0,dpy=0, file="/home/ylevinse/Programming/Beta-Beat.src/SegmentBySegment/test/data/valid/04-47-48_NORMALANALYSIS_SUSSIX_8//twiss.d-_back.dat";


stop;

