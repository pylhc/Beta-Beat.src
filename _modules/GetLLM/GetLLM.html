

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>GetLLM.GetLLM &mdash; Beta-Beat.src 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Beta-Beat.src
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../entrypoints/index.html">Main Entrypoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correction/index.html">Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GetLLM/index.html">GetLLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../harmonic_analysis/index.html">Harmonic Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../online_model/index.html">Online Model Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotshop/index.html">Plotting Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../segment_by_segment/index.html">Segment by Segment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tfs_files/index.html">TFS Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tune_analysis/index.html">Tune Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../twiss_optics/index.html">Twiss Optics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils/index.html">Utils</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Beta-Beat.src</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>GetLLM.GetLLM</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for GetLLM.GetLLM</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">pardir</span>
<span class="n">new_path</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">pardir</span><span class="p">))</span>
<span class="k">if</span> <span class="n">new_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GetLLM</span>
<span class="kn">from</span> <span class="nn">tfs_files</span> <span class="kn">import</span> <span class="n">tfs_pandas</span>
<span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">.. module: GetLLM.GetLLM</span>

<span class="sd">Created on 11/09/09</span>

<span class="sd">:author: Glenn Vanbavinckhove  (gvanbavi@cern.ch)</span>

<span class="sd">:version: 3.00dev</span>


<span class="sd">GetLLM calculates a large collection of optics functions and parameters at the BPMs using the output from DRIVE.</span>

<span class="sd">The GetLLM output is distributed over different files according to the observable and the transverse plane:</span>
<span class="sd"> - getCO*; files containing the closed orbit at all BPMs, one file per plane.</span>
<span class="sd"> - getIP*; files containing beta and phase advance functions at the IPs.</span>
<span class="sd"> - getampbeta*; files containing the beta function as compputed from amplitude, one file per plane (in case of ACdipole free and driven data is also computed).</span>
<span class="sd"> - getbeta*; files containing the beta function as computed from phase advances between 3 BPMs. There is one file per plane (in case of AC-dipole free and driven data is computed).</span>
<span class="sd"> - getchi*; files containing the $\chi$ terms.</span>
<span class="sd"> - getcouple*; files containing the coupling resonances $f_{1001}$  and $f_{0101}$ (in case of AC-dipole free and driven data is computed).</span>
<span class="sd"> - getsex*; files containing the sextupolar resonance driving terms.</span>
<span class="sd"> - getphase*; files containing the phase advances between BPMs, one file per plane (in case of AC-dipole free and driven data is computed).</span>
<span class="sd"> - getphasetot*; files containing the total phase-advance using the first BPM as reference, one file per plane (in case of ACdipole free and driven data is computed).</span>
<span class="sd"> - getkick*; files containing the kick amplitudes and the linear invariants as derived from peak-to-peak values and spectral lines amplitudes.</span>
<span class="sd"> - getD*; files containing the dispersion, one per plane ( if off-momentum data is acquired).</span>
<span class="sd"> - getNDx*; files containing the normalized horizontal dispersion ( if off-momentum data is acquired).</span>


<span class="sd">Usage1::</span>

<span class="sd">    &gt;pythonafs ../GetLLM.py -m ../../MODEL/SPS/twiss.dat -f ../../MODEL/SPS/SimulatedData/ALLBPMs.3 -o ./</span>

<span class="sd">Usage2::</span>

<span class="sd">    &gt;pythonafs ../GetLLM.py -m ../../MODEL/SPS/twiss.dat -d mydictionary.py -f 37gev270amp2_12.sdds.new -o ./</span>


<span class="sd">Change history::</span>

<span class="sd">        git log GetLLM.py</span>


<span class="sd">        --- STRUCTURE ---</span>

<span class="sd">_parse_args()-function</span>
<span class="sd">    _parse_args</span>
<span class="sd">main()-function</span>
<span class="sd">    main</span>
<span class="sd">helper-functions</span>
<span class="sd">    _intial_setup       note the missing i in the name!</span>
<span class="sd">    _create_tfs_files   </span>
<span class="sd">    _analyse_src_files</span>
<span class="sd">    _check_bpm_compatibility</span>
<span class="sd">    _calculate_orbit</span>
<span class="sd">    _phase_and_beta_for_non_zero_dpp</span>
<span class="sd">    _calculate_getsextupoles</span>
<span class="sd">    _calculate_kick</span>
<span class="sd">    _get_calibrated_amplitudes</span>
<span class="sd">    _copy_calibration_files</span>
<span class="sd">helper-classes</span>
<span class="sd">    _GetllmData</span>
<span class="sd">        __init__</span>
<span class="sd">        set_outputpath</span>
<span class="sd">        set_bpmu_and_cut_for_closed_orbit</span>
<span class="sd">    _TwissData</span>
<span class="sd">        __init__</span>
<span class="sd">        has_zero_dpp_x</span>
<span class="sd">        has_non_zero_dpp_x</span>
<span class="sd">        has_zero_dpp_y</span>
<span class="sd">        has_non_zero_dpp_y</span>
<span class="sd">        has_no_input_files</span>
<span class="sd">    _TuneData</span>
<span class="sd">        __init__</span>
<span class="sd">        initialize_tunes</span>
<span class="sd">main invocation</span>
<span class="sd">    _start</span>
<span class="sd">    call _start()</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">Python_Classes4MAD.metaclass</span>
<span class="kn">from</span> <span class="nn">tfs_utils_getllm</span> <span class="kn">import</span> <span class="n">GetllmTfsFile</span>
<span class="kn">import</span> <span class="nn">algorithms.helper</span>
<span class="kn">import</span> <span class="nn">algorithms.phase</span>
<span class="kn">import</span> <span class="nn">algorithms.beta</span>
<span class="kn">import</span> <span class="nn">algorithms.compensate_ac_effect</span>
<span class="kn">import</span> <span class="nn">algorithms.dispersion</span>
<span class="kn">import</span> <span class="nn">algorithms.coupling</span>
<span class="kn">import</span> <span class="nn">algorithms.resonant_driving_terms</span>
<span class="kn">import</span> <span class="nn">algorithms.interaction_point</span>
<span class="kn">import</span> <span class="nn">algorithms.chi_terms</span>
<span class="kn">import</span> <span class="nn">algorithms.constants</span>
<span class="kn">import</span> <span class="nn">utils.iotools</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">logging_tools</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging_tools</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span><span class="n">logging_tools</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span><span class="n">logging_tools</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="c1">####</span>
<span class="c1">#######</span>
<span class="c1">#########</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;V3.0.0 Dev&#39;</span>
<span class="c1">#########</span>
<span class="c1">#######</span>
<span class="c1">####</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">debug</span>  <span class="c1"># True with python option -d! (&quot;python -d GetLLM.py...&quot;) (vimaier)</span>

<span class="c1"># default arguments:</span>

<span class="n">ACCEL</span>       <span class="o">=</span> <span class="s2">&quot;LHCB1&quot;</span>   <span class="c1">#@IgnorePep8</span>
<span class="n">DICT</span>        <span class="o">=</span> <span class="s2">&quot;0&quot;</span>       <span class="c1">#@IgnorePep8</span>
<span class="n">MODELTWISS</span>  <span class="o">=</span> <span class="s2">&quot;0&quot;</span>       <span class="c1">#@IgnorePep8</span>
<span class="n">FILES</span>       <span class="o">=</span> <span class="s2">&quot;0&quot;</span>       <span class="c1">#@IgnorePep8</span>
<span class="n">COCUT</span>       <span class="o">=</span> <span class="mi">4000</span>      <span class="c1">#@IgnorePep8</span>
<span class="n">OUTPATH</span>     <span class="o">=</span> <span class="s2">&quot;./&quot;</span>      <span class="c1">#@IgnorePep8</span>
<span class="n">NBCPL</span>       <span class="o">=</span> <span class="mi">2</span>         <span class="c1">#@IgnorePep8</span>
<span class="n">NONLINEAR</span>   <span class="o">=</span> <span class="kc">False</span>     <span class="c1">#@IgnorePep8</span>
<span class="n">TBTANA</span>      <span class="o">=</span> <span class="s2">&quot;SUSSIX&quot;</span>  <span class="c1">#@IgnorePep8</span>
<span class="n">BPMUNIT</span>     <span class="o">=</span> <span class="s2">&quot;um&quot;</span>      <span class="c1">#@IgnorePep8</span>
<span class="n">LHCPHASE</span>    <span class="o">=</span> <span class="s2">&quot;0&quot;</span>       <span class="c1">#@IgnorePep8</span>
<span class="n">BBTHRESH</span>    <span class="o">=</span> <span class="s2">&quot;0.15&quot;</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">ERRTHRESH</span>   <span class="o">=</span> <span class="s2">&quot;0.15&quot;</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">NUMBER_OF_BPMS</span>  <span class="o">=</span> <span class="mi">10</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">RANGE_OF_BPMS</span>   <span class="o">=</span> <span class="mi">11</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">AVERAGE_TUNE</span>    <span class="o">=</span> <span class="mi">0</span>     <span class="c1">#@IgnorePep8</span>
<span class="n">CALIBRATION</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#@IgnorePep8</span>
<span class="n">ERRORDEFS</span>       <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#@IgnorePep8</span>
<span class="n">NPROCESSES</span>      <span class="o">=</span> <span class="mi">16</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">ONLYCOUPLING</span>    <span class="o">=</span> <span class="mi">0</span>     <span class="c1">#@IgnorePep8</span>
<span class="n">USE_ONLY_THREE_BPMS_FOR_BETA_FROM_PHASE</span>   <span class="o">=</span> <span class="mi">0</span>    <span class="c1">#@IgnorePep8</span>
<span class="n">DEFAULT_USE_ERROR_OF_MEAN</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#@IgnorePep8</span>

<span class="c1">#===================================================================================================</span>
<span class="c1"># _parse_args()-function</span>
<span class="c1">#===================================================================================================</span>
<span class="k">def</span> <span class="nf">_parse_args</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Parses command line arguments. &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--accel&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which accelerator: LHCB1 LHCB2 LHCB4? SPS RHIC TEVATRON&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ACCEL&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ACCEL</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ACCEL&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--dictionary&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File with the BPM dictionary&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;DICT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DICT</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dict&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Twiss free model file *.dat. For free oscillations, ONLY the file *.dat should be present in the path. For AC dipole, the path should also contain a file *_ac.dat (BOTH files a needed in this case).&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;MODELTWISS&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MODELTWISS</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;Twiss&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--files&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Files from analysis, separated by comma&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILES&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">FILES</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output Path&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">OUTPATH</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--cocut&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cut for closed orbit measurement [um]&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COCUT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">COCUT</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;COcut&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--nbcpl&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Analysis option for coupling, 1 bpm or 2 bpms&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;NBCPL&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NBCPL</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;NBcpl&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--tbtana&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn-by-turn data analysis algorithm: SUSSIX, SVD or HA&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TBTANA&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">TBTANA</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;TBTana&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--nonlinear&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run the RDT analysis&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;NONLINEAR&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NONLINEAR</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;nonlinear&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--useerrorofmean&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If true, use standard error instread of standard deviation.&quot;</span><span class="p">,</span> 
                      <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;DEFAULT_USE_ERROR_OF_MEAN&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_USE_ERROR_OF_MEAN</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_error_of_mean&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--bpmu&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;BPMunit: um, mm, cm, m (default um)&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;BPMUNIT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">BPMUNIT</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;BPMUNIT&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--lhcphase&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Compensate phase shifts by tunes for the LHC experiment data, off=0(default)/on=1&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;LHCPHASE&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">LHCPHASE</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;lhcphase&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="s2">&quot;--bbthreshold&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set beta-beating threshold for action calculations, default = 0.15&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;BBTHRESH&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">BBTHRESH</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;bbthreshold&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--errthreshold&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set beta relative uncertainty threshold for action calculations, default = 0.1&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ERRTHRESH&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ERRTHRESH</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;errthreshold&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="s2">&quot;--threebpm&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Forces to use the 3 BPM method, yes=1/no=0, default = 0&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;USE_ONLY_THREE_BPMS_FOR_BETA_FROM_PHASE&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">USE_ONLY_THREE_BPMS_FOR_BETA_FROM_PHASE</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_only_three_bpms_for_beta_from_phase&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="s2">&quot;--numbpm&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of different BPM combinations for beta-calculation, default = 10&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;NUMBER_OF_BPMS&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NUMBER_OF_BPMS</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;number_of_bpms&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--range&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Range of BPM for beta-calculation (&gt;=3 and odd), default = 11&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;RANGE_OF_BPMS&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">RANGE_OF_BPMS</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;range_of_bpms&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--average_tune&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set to 1 to use average tune for all BPMs instead of specific for each one.&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;AVERAGE_TUNE&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">AVERAGE_TUNE</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_average&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--calibration&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the directory where the calibration files (calibration_x.out, calibration_y.out) are stored.&quot;</span><span class="p">,</span>
                    <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CALIBRATION&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CALIBRATION</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;calibration_dir_path&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--errordefs&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Gives path to the error definition file. If specified, the analytical formula will be used to calculate weighted beta and alpha. Default = None&quot;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATH_TO_FILE&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ERRORDEFS</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;errordefspath&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--nprocesses&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NPROCESSES</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;nprocesses&quot;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;NPROCESSES&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the number of processes used. -1: take the number of CPUs 0: run serially &gt;1: take the specified number. default = </span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NPROCESSES</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--coupling&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ONLYCOUPLING</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;onlycoupling&quot;</span><span class="p">,</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ONLYCOUPLING&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;When enabled only coupling is calculated. &quot;</span><span class="p">)</span>


    <span class="c1"># awegsche June 2016, option to include an errorfile</span>
    <span class="c1"># update August 2016, looking by default for this file, raising error if unable to find it</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">options</span>


<span class="k">def</span> <span class="nf">get_times</span><span class="p">(</span><span class="n">files_to_analyse</span><span class="p">):</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_to_analyse</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="n">meas</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">tm</span> <span class="o">=</span> <span class="n">meas</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">34</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_obj</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">tm</span><span class="p">,</span> <span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">@%H_%M_%S_</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="n">unix_time_utc</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time_obj</span><span class="p">)</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unix_time_utc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">times</span>


<span class="c1">#===================================================================================================</span>
<span class="c1"># main()-function</span>
<span class="c1">#===================================================================================================</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../GetLLM/index.html#GetLLM.GetLLM.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">outputpath</span><span class="p">,</span>
         <span class="n">files_to_analyse</span><span class="p">,</span>
         <span class="n">model_filename</span><span class="p">,</span>
         <span class="n">dict_file</span><span class="o">=</span><span class="n">DICT</span><span class="p">,</span>
         <span class="n">accel</span><span class="o">=</span><span class="n">ACCEL</span><span class="p">,</span>
         <span class="n">lhcphase</span><span class="o">=</span><span class="n">LHCPHASE</span><span class="p">,</span>
         <span class="n">bpmu</span><span class="o">=</span><span class="n">BPMUNIT</span><span class="p">,</span>
         <span class="n">cocut</span><span class="o">=</span><span class="n">COCUT</span><span class="p">,</span>
         <span class="n">nbcpl</span><span class="o">=</span><span class="n">NBCPL</span><span class="p">,</span>
         <span class="n">nonlinear</span><span class="o">=</span><span class="n">NONLINEAR</span><span class="p">,</span>
         <span class="n">tbtana</span><span class="o">=</span><span class="n">TBTANA</span><span class="p">,</span>
         <span class="n">bbthreshold</span><span class="o">=</span><span class="n">BBTHRESH</span><span class="p">,</span>
         <span class="n">errthreshold</span><span class="o">=</span><span class="n">ERRTHRESH</span><span class="p">,</span>
         <span class="n">use_only_three_bpms_for_beta_from_phase</span><span class="o">=</span><span class="n">USE_ONLY_THREE_BPMS_FOR_BETA_FROM_PHASE</span><span class="p">,</span>
         <span class="n">number_of_bpms</span><span class="o">=</span><span class="n">NUMBER_OF_BPMS</span><span class="p">,</span>
         <span class="n">range_of_bpms</span><span class="o">=</span><span class="n">RANGE_OF_BPMS</span><span class="p">,</span>
         <span class="n">use_average</span><span class="o">=</span><span class="n">AVERAGE_TUNE</span><span class="p">,</span>
         <span class="n">calibration_dir_path</span><span class="o">=</span><span class="n">CALIBRATION</span><span class="p">,</span>
         <span class="n">errordefspath</span><span class="o">=</span><span class="n">ERRORDEFS</span><span class="p">,</span>
         <span class="n">nprocesses</span><span class="o">=</span><span class="n">NPROCESSES</span><span class="p">,</span>
         <span class="n">onlycoupling</span><span class="o">=</span><span class="n">ONLYCOUPLING</span><span class="p">,</span>
         <span class="n">use_error_of_mean</span><span class="o">=</span><span class="n">DEFAULT_USE_ERROR_OF_MEAN</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    GetLLM main function.</span>

<span class="sd">    :param string outputpath: The output path to store results</span>
<span class="sd">    :param string files_to_analyse: List of files, comma separated string.</span>
<span class="sd">    :param string model_filename: Path and filename of model to be used</span>
<span class="sd">    :param string dict_file: Name of the script which will be executed. Should store dictionary with</span>
<span class="sd">                    mappings of BPM names.</span>
<span class="sd">    :param string accel: Type of accelerator. LHCB1, LHCB2, LHCB4, RHIC, SPS</span>
<span class="sd">    :param string lhcphase: &quot;0&quot; or &quot;1&quot; -- Compensate phase shifts by tunes for the LHC experiment data,</span>
<span class="sd">                             off=0(default)/on=1</span>
<span class="sd">    :param string BPMU: BPMunit: &quot;um&quot;, &quot;mm&quot;, &quot;cm&quot;, &quot;m&quot; (default &quot;um&quot;)</span>
<span class="sd">    :param int COcut: Cut for closed orbit measurement [um]</span>
<span class="sd">    :param int NBcpl: For selecting the coupling measurement method 1 bpm or 2 bpms</span>
<span class="sd">    :param string TBTana: Turn-by-turn data analysis algorithm: SUSSIX, SVD or HA</span>
<span class="sd">    :param string bbthreshold: Threshold for _calculate_kick for (beta_d-beta_m)/beta_m</span>
<span class="sd">    :param string errthreshold: Threshold for calculate_kick for sigma(beta_d)/beta_d</span>
<span class="sd">    :param int use_only_three_bpms_for_beta_from_phase:</span>
<span class="sd">    :param int number_of_bpms: Number of BPM-combos for beta from phase</span>
<span class="sd">    :param int range_of_bpms: Range of BPMs for beta from phase</span>
<span class="sd">    :param int use_average: Uses AVG_MUX and AVG_MUY in _analyse_src_files if 1</span>
<span class="sd">    :returns: int  -- 0 if the function run successfully otherwise !=0.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">return_code</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nb">print</span> <span class="s2">&quot;Starting GetLLM &quot;</span><span class="p">,</span> <span class="n">VERSION</span>
    
    <span class="n">use_average</span> <span class="o">=</span> <span class="p">(</span><span class="n">use_average</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">use_only_three_bpms_for_beta_from_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">use_only_three_bpms_for_beta_from_phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># The following objects stores multiple variables for GetLLM to avoid having many local</span>
    <span class="c1"># variables. Identifiers supposed to be as short as possible.</span>
    <span class="c1"># --vimaier</span>
    <span class="n">twiss_d</span> <span class="o">=</span> <span class="n">_TwissData</span><span class="p">()</span>
    <span class="n">tune_d</span> <span class="o">=</span> <span class="n">_TuneData</span><span class="p">()</span>
    <span class="n">getllm_d</span> <span class="o">=</span> <span class="n">_GetllmData</span><span class="p">()</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">set_outputpath</span><span class="p">(</span><span class="n">outputpath</span><span class="p">)</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">set_bpmu_and_cut_for_closed_orbit</span><span class="p">(</span><span class="n">cocut</span><span class="p">,</span> <span class="n">bpmu</span><span class="p">)</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">lhc_phase</span> <span class="o">=</span> <span class="n">lhcphase</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">num_bpms_for_coupling</span> <span class="o">=</span> <span class="n">nbcpl</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">number_of_bpms</span> <span class="o">=</span> <span class="n">number_of_bpms</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">range_of_bpms</span> <span class="o">=</span> <span class="n">range_of_bpms</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">use_only_three_bpms_for_beta_from_phase</span> <span class="o">=</span> <span class="n">use_only_three_bpms_for_beta_from_phase</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">errordefspath</span> <span class="o">=</span> <span class="n">errordefspath</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">accel</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">nprocesses</span> <span class="o">=</span> <span class="n">nprocesses</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">onlycoupling</span> <span class="o">=</span> <span class="n">onlycoupling</span>

    <span class="n">algorithms</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">USE_ERROR_OF_MEAN</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">use_error_of_mean</span><span class="p">)</span>
    <span class="n">dinj</span> <span class="o">=</span> <span class="n">DepInjector</span><span class="p">()</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="n">getllm_d</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;bbthreshold&quot;</span><span class="p">,</span> <span class="n">bbthreshold</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;errthreshold&quot;</span><span class="p">,</span> <span class="n">errthreshold</span><span class="p">)</span>
    <span class="c1"># Setup</span>
    <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">,</span> <span class="n">bpm_dictionary</span><span class="p">,</span> <span class="n">mad_elem</span><span class="p">,</span> <span class="n">mad_best_knowledge</span><span class="p">,</span> <span class="n">mad_ac_best_knowledge</span><span class="p">,</span> <span class="n">mad_elem_centre</span> <span class="o">=</span> <span class="n">_intial_setup</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span>
                                                                                                                            <span class="n">model_filename</span><span class="p">,</span>
                                                                                                                            <span class="n">dict_file</span><span class="p">)</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_elem&quot;</span><span class="p">,</span> <span class="n">mad_elem</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_best_knowledge&quot;</span><span class="p">,</span> <span class="n">mad_best_knowledge</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_ac_best_knowledge&quot;</span><span class="p">,</span> <span class="n">mad_ac_best_knowledge</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;mad_elem_centre&quot;</span><span class="p">,</span> <span class="n">mad_elem_centre</span><span class="p">)</span>

    <span class="n">kick_times</span> <span class="o">=</span> <span class="n">get_times</span><span class="p">(</span><span class="n">files_to_analyse</span><span class="p">)</span>



    <span class="c1"># Creates the output files dictionary</span>
    <span class="n">files_dict</span> <span class="o">=</span> <span class="n">_create_tfs_files</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">model_filename</span><span class="p">,</span> <span class="n">nonlinear</span><span class="p">)</span>

    <span class="c1"># Copy calibration files calibration_x/y.out from calibration_dir_path to outputpath</span>
    <span class="n">calibration_twiss</span> <span class="o">=</span> <span class="n">_copy_calibration_files</span><span class="p">(</span><span class="n">outputpath</span><span class="p">,</span> <span class="n">calibration_dir_path</span><span class="p">)</span>
    <span class="n">twiss_d</span><span class="p">,</span> <span class="n">files_dict</span> <span class="o">=</span> <span class="n">_analyse_src_files</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">,</span> <span class="n">files_to_analyse</span><span class="p">,</span> <span class="n">nonlinear</span><span class="p">,</span> <span class="n">tbtana</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">,</span> <span class="n">use_average</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">)</span>

    <span class="n">dinj</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;calibration_twiss&quot;</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;temp_dict&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">files_dict</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;kick_times&quot;</span><span class="p">,</span> <span class="n">kick_times</span><span class="p">)</span>

    <span class="c1"># Load tunes from twiss instances, depending on with_ac_calc</span>
    <span class="n">tune_d</span><span class="o">.</span><span class="n">initialize_tunes</span><span class="p">(</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">)</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="p">)</span>

    <span class="c1"># Construct pseudo-double plane BPMs</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span> <span class="o">==</span> <span class="s2">&quot;SPS&quot;</span> <span class="ow">or</span> <span class="s2">&quot;RHIC&quot;</span> <span class="ow">in</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_zero_dpp_x</span><span class="p">()</span> <span class="ow">and</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_zero_dpp_y</span><span class="p">():</span>
        <span class="p">[</span><span class="n">pseudo_list_x</span><span class="p">,</span> <span class="n">pseudo_list_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">pseudo_double_plane_monitors</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">,</span> <span class="n">bpm_dictionary</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize variables otherwise calculate_coupling would raise an exception(vimaier)</span>
        <span class="n">pseudo_list_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pseudo_list_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;pseudo_list_x&quot;</span><span class="p">,</span> <span class="n">pseudo_list_x</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">initial</span><span class="p">(</span><span class="s2">&quot;pseudo_list_y&quot;</span><span class="p">,</span> <span class="n">pseudo_list_y</span><span class="p">)</span>

    <span class="c1"># -------- Check monitor compatibility between data and model</span>
    <span class="n">_check_bpm_compatibility</span><span class="p">(</span><span class="n">twiss_d</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">)</span>

    <span class="c1"># -------- START Phase for beta calculation with best knowledge model in ac phase compensation</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">onlycoupling</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">calculate_phase</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;phase_d_bk&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_best_knowledge&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac_best_knowledge&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_elem&quot;</span><span class="p">,</span> <span class="s2">&quot;temp_dict&quot;</span><span class="p">))</span>

    <span class="c1"># -------- START Phase</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">calculate_phase</span><span class="p">,</span>
                 <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">),</span>
                 <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_elem&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>

    <span class="c1"># -------- START coupling.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">num_bpms_for_coupling</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">coupling</span><span class="o">.</span><span class="n">calculate_coupling</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;pseudo_list_x&quot;</span><span class="p">,</span> <span class="s2">&quot;pseudo_list_y&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nbcpl (num_bpms_for_coupling) is is zero or negative: skipping coupling calculation&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">onlycoupling</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># -------- START Total Phase</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">calculate_total_phase</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;phase_tot&quot;</span><span class="p">,),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>

        <span class="c1"># -------- START Beta</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">calculate_beta_from_phase</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;beta_d&quot;</span><span class="p">,</span> <span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d_bk&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_elem&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_elem_centre&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_best_knowledge&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_ac_best_knowledge&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>


        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">calculate_beta_from_amplitude</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;beta_d&quot;</span><span class="p">,</span> <span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;beta_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>


        <span class="c1"># -------- START IP</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">interaction_point</span><span class="o">.</span><span class="n">betastar_from_phase</span><span class="p">,</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d.accel&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>

        <span class="c1"># -------- START Orbit</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">_calculate_orbit</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;list_of_co_x&quot;</span><span class="p">,</span> <span class="s2">&quot;list_of_co_y&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>

        <span class="c1"># -------- START Dispersion</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">dispersion</span><span class="o">.</span><span class="n">calculate_dispersion</span><span class="p">,</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_d.x_amp&quot;</span><span class="p">,</span> <span class="s2">&quot;list_of_co_x&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;list_of_co_y&quot;</span><span class="p">))</span>

        <span class="c1"># ------ Start get Q,JX,delta</span>
        <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">_calculate_kick</span><span class="p">,</span>
                     <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;inv_x&quot;</span><span class="p">,</span> <span class="s2">&quot;inv_y&quot;</span><span class="p">),</span>
                     <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;kick_times&quot;</span><span class="p">,</span> <span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_d&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_ac&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;bbthreshold&quot;</span><span class="p">,</span> <span class="s2">&quot;errthreshold&quot;</span><span class="p">))</span>

        <span class="c1"># -------- START RDTs</span>
        <span class="k">if</span> <span class="n">nonlinear</span><span class="p">:</span>
            <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">resonant_driving_terms</span><span class="o">.</span><span class="n">calculate_RDTs</span><span class="p">,</span>
                         <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span> <span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d&quot;</span><span class="p">,</span> <span class="s2">&quot;files_dict&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;inv_x&quot;</span><span class="p">,</span> <span class="s2">&quot;inv_y&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">tbtana</span> <span class="o">==</span> <span class="s2">&quot;SUSSIX&quot;</span><span class="p">:</span>
            <span class="c1"># ------  Start getsextupoles @ Glenn Vanbavinckhove</span>
            <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">_calculate_getsextupoles</span><span class="p">,</span>
                         <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="p">),</span>
                         <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;tune_d.q1f&quot;</span><span class="p">))</span>

            <span class="c1"># ------ Start getchiterms @ Glenn Vanbavinckhove</span>
            <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">algorithms</span><span class="o">.</span><span class="n">chi_terms</span><span class="o">.</span><span class="n">calculate_chiterms</span><span class="p">,</span>
                         <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="p">),</span>
                         <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getllm_d&quot;</span><span class="p">,</span> <span class="s2">&quot;twiss_d&quot;</span><span class="p">,</span> <span class="s2">&quot;mad_twiss&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;files_dict&quot;</span><span class="p">))</span>

    <span class="c1"># Write results to files in files_dict</span>
    <span class="n">dinj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">funct</span><span class="o">=</span><span class="n">write_files</span><span class="p">,</span>
                 <span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;files_dict&quot;</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dinj</span><span class="o">.</span><span class="n">something_raised</span> <span class="k">else</span> <span class="mi">1</span></div>

<span class="c1"># END main() ---------------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">write_files</span><span class="p">(</span><span class="n">files_dict</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Writing files&quot;</span>
    <span class="k">for</span> <span class="n">tfsfile</span> <span class="ow">in</span> <span class="n">files_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="n">tfsfile</span><span class="o">.</span><span class="n">write_to_file</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="DepInjector"><a class="viewcode-back" href="../../GetLLM/index.html#GetLLM.GetLLM.DepInjector">[docs]</a><span class="k">class</span> <span class="nc">DepInjector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Small &quot;kind of&quot; dependency injector to handle GetLLM operations.</span>

<span class="sd">    This class provides a shared namespace of dependencies between GetLLM</span>
<span class="sd">    operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">something_raised</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DepInjector.trigger"><a class="viewcode-back" href="../../GetLLM/index.html#GetLLM.GetLLM.DepInjector.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolves dependecies and runs the function given in &quot;funct&quot;.</span>

<span class="sd">        Launches the function given in &quot;funct&quot; defining the return variables</span>
<span class="sd">        given in &quot;provides&quot;.</span>
<span class="sd">        This function will check that all the names given in &quot;requires&quot; are</span>
<span class="sd">        already defined in the injector namespace with a result values,</span>
<span class="sd">        otherwise a KeyError will be thrown. If at least one of the requieres</span>
<span class="sd">        is marked as unavailable (because its defining computation failed),</span>
<span class="sd">        this computation will mark its own &quot;provides&quot; as unavailable as well.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            funct: Callable to run.</span>
<span class="sd">            requires: Iterable of names that must be availabe for this to run.</span>
<span class="sd">            provides: Iterable of names that &quot;funct&quot; defines. It must have the</span>
<span class="sd">                same length as the values &quot;funct&quot; returns.</span>
<span class="sd">            critical: If true, if for some reason this function cannot run, an</span>
<span class="sd">                exception will be raised.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The same instance of DepInjector to allow method chaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_solve_dep</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">requires</span><span class="p">]</span>\
            <span class="k">if</span> <span class="n">requires</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
            <span class="k">else</span> <span class="p">[]</span>
        <span class="n">provides</span> <span class="o">=</span> <span class="n">provides</span> <span class="k">if</span> <span class="n">provides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">DepInjector</span><span class="o">.</span><span class="n">Unavailable</span><span class="p">)</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">):</span>
            <span class="c1"># Unavailable dependecies, so I cannot go on:</span>
            <span class="k">if</span> <span class="n">critical</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DepInjector</span><span class="o">.</span><span class="n">MissingRequirementError</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_provides_unavailable</span><span class="p">(</span><span class="n">provides</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Lazy evaluation would be cooler, but this is GetLLM...</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">DepInjector</span><span class="o">.</span><span class="n">_to_tuple</span><span class="p">(</span><span class="n">funct</span><span class="p">(</span><span class="o">*</span><span class="n">deps</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">something_raised</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">critical</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="c1"># Report exception and mark dependencies as Unavailable:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_provides_unavailable</span><span class="p">(</span><span class="n">provides</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">provides</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">provides</span><span class="p">,</span>
                                         <span class="n">DepInjector</span><span class="o">.</span><span class="n">_to_tuple</span><span class="p">(</span><span class="n">results</span><span class="p">))))</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DepInjector.initial"><a class="viewcode-back" href="../../GetLLM/index.html#GetLLM.GetLLM.DepInjector.initial">[docs]</a>    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provides</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defines a value in the dependency injector namespace.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            provides: Name of the value to define.</span>
<span class="sd">            value: Value of the value to define.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">provides</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_solve_dep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>  <span class="c1"># Allowes attribute access</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">inst</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">DepInjector</span><span class="o">.</span><span class="n">Unavailable</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">inst</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">rest</span><span class="p">:</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">subnode</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inst</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_provides_unavailable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provides</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">provides</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DepInjector</span><span class="o">.</span><span class="n">Unavailable</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_tuple</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">thing</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Unavailable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="DepInjector.MissingRequirementError"><a class="viewcode-back" href="../../GetLLM/index.html#GetLLM.GetLLM.DepInjector.MissingRequirementError">[docs]</a>    <span class="k">class</span> <span class="nc">MissingRequirementError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<span class="c1">#==============================================================================</span>
<span class="c1"># helper-functions</span>
<span class="c1">#==============================================================================</span>
<span class="k">def</span> <span class="nf">_intial_setup</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">model_filename</span><span class="p">,</span> <span class="n">dict_file</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">dict_file</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="n">bpm_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">execfile</span><span class="p">(</span><span class="n">dict_file</span><span class="p">)</span>
        <span class="n">bpm_dictionary</span> <span class="o">=</span> <span class="n">dictionary</span>  <span class="c1"># temporarily since presently name is not bpm_dictionary</span>

    <span class="c1"># Beam direction</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span> <span class="o">==</span> <span class="s2">&quot;LHCB2&quot;</span><span class="p">:</span>
        <span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># THIS IS CORRECT, be careful with tune sign in SUSSIX and eigenmode order in SVD</span>
    <span class="k">elif</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span> <span class="o">==</span> <span class="s2">&quot;LHCB4&quot;</span><span class="p">:</span>
        <span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># IS THIS CORRECT? I (rogelio) try for Simon...</span>
        <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="s2">&quot;LHCB2&quot;</span>  <span class="c1"># This is because elements later are named B2 anyway, not B4</span>

    <span class="c1">#-- finding base model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mad_twiss</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="p">,</span> <span class="n">bpm_dictionary</span><span class="p">)</span>  <span class="c1"># model from MAD : Twiss instance</span>
        <span class="nb">print</span> <span class="s2">&quot;Base model found!&quot;</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Twiss file loading failed for:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_filename</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Provide a valid model file.&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#-- finding the ac dipole model</span>
    <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ac_filename</span> <span class="o">=</span> <span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_ac.dat&quot;</span><span class="p">)</span>
    <span class="n">adt_filename</span> <span class="o">=</span> <span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_adt.dat&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ac_filename</span><span class="p">):</span>
            
            <span class="n">mad_ac</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">ac_filename</span><span class="p">)</span>  <span class="c1"># model with ac dipole : Twiss instance</span>
            <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span> <span class="s2">&quot;Driven Twiss file found.</span><span class="se">\n</span><span class="s2">AC dipole effects calculated with the effective model (get***_free2.out). INFO: ADT will be omitted&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_ac_best_knowledge.dat&quot;</span><span class="p">))</span>
                <span class="nb">print</span> <span class="s2">&quot;Best knowledge model found for AC diapole, it will be used for beta calculation.&quot;</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">mad_ac</span>
                <span class="nb">print</span> <span class="s2">&quot;Best knowledge model not found for AC diapole.&quot;</span>
            <span class="n">getllm_d</span><span class="o">.</span><span class="n">acdipole</span> <span class="o">=</span> <span class="s2">&quot;ACD&quot;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adt_filename</span><span class="p">):</span>
    
            <span class="n">mad_ac</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">adt_filename</span><span class="p">)</span>  <span class="c1"># model with ac dipole : Twiss instance</span>
            <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span> <span class="s2">&quot;Driven Twiss file found. ADT-AC-dipole effects calculated with the effective model (get***_free2.out).&quot;</span>
            <span class="nb">print</span> <span class="s2">&quot;Note: Using normal AC Dipole will be omitted.&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_adt_best_knowledge.dat&quot;</span><span class="p">))</span>
                <span class="nb">print</span> <span class="s2">&quot;Best knowledge model found for ADT-AC-dipole, it will be used for beta calculation.&quot;</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">mad_ac</span>
                <span class="nb">print</span> <span class="s2">&quot;Best knowledge model not found for ADT-AC-dipole.&quot;</span>
            <span class="n">getllm_d</span><span class="o">.</span><span class="n">acdipole</span> <span class="o">=</span> <span class="s2">&quot;ADT&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARN: AC dipole effects not calculated. Driven twiss file does not exsist !&quot;</span>
            <span class="n">mad_ac</span> <span class="o">=</span> <span class="n">mad_twiss</span>
            <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">mad_twiss</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">mad_ac</span> <span class="o">=</span> <span class="n">mad_twiss</span>
        <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">mad_twiss</span>
        <span class="nb">print</span> <span class="s2">&quot;WARN: IOError in loading ac/adt file.&quot;</span>


    <span class="c1">#-- Test if the AC dipole (MKQA) is in the model of LHC</span>
    <span class="c1">#TODO: This was crashing for dpp cases (WAnalysis or normal) I put this try to &quot;fix&quot; it, it should be check.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mad_elem</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_elements.dat&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mad_elem_centre</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_elements_centre.dat&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">mad_elem_centre</span> <span class="o">=</span> <span class="n">mad_elem</span>
            <span class="nb">print</span> <span class="s2">&quot;WARN: No elements_centre found, use end points instead. This shouldn&#39;t change much but is not recommended&quot;</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;ERROR: twiss_elements (filename </span><span class="si">{0:s}</span><span class="s2">) not found. Systematic error calculation will fail.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_elements.dat&quot;</span><span class="p">))</span>
        <span class="n">mad_elem</span> <span class="o">=</span> <span class="n">mad_twiss</span>
        <span class="n">mad_elem_centre</span> <span class="o">=</span> <span class="n">mad_elem</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;LHC&#39;</span> <span class="ow">in</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;MKQA.6L4.&#39;</span> <span class="o">+</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="nb">print</span> <span class="s2">&quot;AC dipole found in the model. AC dipole effects calculated with analytic equations (get***_free.out)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;AC dipole found in the model. AC dipole effects calculated with analytic equations (get***_free.out)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;WARN: AC dipole effects calculated with analytic equations only for LHC for now&#39;</span>

    <span class="c1">#-- Try to find the best knowledge model</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mad_best_knowledge</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">model_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;_best_knowledge.dat&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
            <span class="n">mad_ac_best_knowledge</span> <span class="o">=</span> <span class="n">mad_best_knowledge</span>
        <span class="nb">print</span> <span class="s2">&quot;Best knowledge model found, it will be used for beta calculation.&quot;</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">mad_best_knowledge</span> <span class="o">=</span> <span class="n">mad_twiss</span>
        <span class="nb">print</span> <span class="s2">&quot;Best knowledge model not found.&quot;</span>
        
    <span class="c1"># look for file with important BPM pairs</span>
    <span class="n">pairsfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/important_pairs&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pairsfilename</span><span class="p">):</span>
        <span class="n">getllm_d</span><span class="o">.</span><span class="n">important_pairs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pair_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pairsfilename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pair_file</span><span class="p">:</span>
            <span class="n">key_value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">key_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">important_pairs</span><span class="p">:</span>
                <span class="n">getllm_d</span><span class="o">.</span><span class="n">important_pairs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">getllm_d</span><span class="o">.</span><span class="n">important_pairs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">,</span> <span class="n">bpm_dictionary</span><span class="p">,</span> <span class="n">mad_elem</span><span class="p">,</span> <span class="n">mad_best_knowledge</span><span class="p">,</span> <span class="n">mad_ac_best_knowledge</span><span class="p">,</span> <span class="n">mad_elem_centre</span>



<span class="c1"># END _intial_setup ---------------------------------------------------------------------------------</span>

    
<span class="k">def</span> <span class="nf">_create_tfs_files</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">model_filename</span><span class="p">,</span> <span class="n">nonlinear</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates the most tfs files and stores it in an dictionary whereby the key represents the file</span>
<span class="sd">    and the value is the corresponding GetllmTfsFile.</span>

<span class="sd">    :Return: dict: string --&gt; GetllmTfsFile</span>
<span class="sd">            A dictionary of created GetllmTfsFile objects. Keys are the filenames and values are the</span>
<span class="sd">            GetllmTfsFile objects.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Static variable of GetllmTfsFile to save the outputfile, GetLLM version and model filename</span>
    <span class="n">GetllmTfsFile</span><span class="o">.</span><span class="n">s_output_path</span> <span class="o">=</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">outputpath</span>
    <span class="n">GetllmTfsFile</span><span class="o">.</span><span class="n">s_getllm_version</span> <span class="o">=</span> <span class="n">VERSION</span>
    <span class="n">GetllmTfsFile</span><span class="o">.</span><span class="n">s_mad_filename</span> <span class="o">=</span> <span class="n">model_filename</span>

    <span class="n">files_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasex.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasey.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetotx.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetoty.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasex_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasey_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasex_free2.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasey_free2.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetotx_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetoty_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetotx_free2.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getphasetoty_free2.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetax.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetay.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetax_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetay_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetax_free2.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getbetay_free2.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetax.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetay.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetax_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetay_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetax_free2.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getampbetay_free2.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOy.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getCOy.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getNDx.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getNDx.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDx.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getDx.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDy.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getDy.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getcouple.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nonlinear</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rdt</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">resonant_driving_terms</span><span class="o">.</span><span class="n">RDT_LIST</span><span class="p">:</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="n">rdt</span><span class="o">+</span><span class="s1">&#39;_line.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="n">rdt</span> <span class="o">+</span> <span class="s1">&#39;_line.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="n">rdt</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="n">rdt</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getcouple_free.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getcouple_free2.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcoupleterms.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getcoupleterms.out&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;LHC&quot;</span> <span class="ow">in</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">:</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIP.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIP.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPx.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPy.out&#39;</span><span class="p">)</span>
        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPfromphase.out&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPx_free.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPy_free.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPx_free2.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPy_free2.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase_free.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPfromphase_free.out&#39;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase_free2.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getIPfromphase_free2.out&#39;</span><span class="p">)</span>

    <span class="n">files_dict</span><span class="p">[</span><span class="s2">&quot;getsex3000.out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s2">&quot;getsex3000.out&quot;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getchi3000.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getchi3000.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getchi1010.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getchi1010.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkick.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getkick.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkickphase.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getkickphase.out&#39;</span><span class="p">)</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkickac.out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="s1">&#39;getkickac.out&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">files_dict</span>
<span class="c1"># END _create_tfs_files -----------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_analyse_src_files</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">,</span> <span class="n">files_to_analyse</span><span class="p">,</span> <span class="n">nonlinear</span><span class="p">,</span> <span class="n">turn_by_turn_algo</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">,</span> <span class="n">use_average</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">turn_by_turn_algo</span> <span class="o">==</span> <span class="s2">&quot;SUSSIX&quot;</span><span class="p">:</span>
        <span class="n">suffix_x</span> <span class="o">=</span> <span class="s1">&#39;_linx&#39;</span>
        <span class="n">suffix_y</span> <span class="o">=</span> <span class="s1">&#39;_liny&#39;</span>
    <span class="k">elif</span> <span class="n">turn_by_turn_algo</span> <span class="o">==</span> <span class="s1">&#39;SVD&#39;</span><span class="p">:</span>
        <span class="n">suffix_x</span> <span class="o">=</span> <span class="s1">&#39;_svdx&#39;</span>
        <span class="n">suffix_y</span> <span class="o">=</span> <span class="s1">&#39;_svdy&#39;</span>
    <span class="k">elif</span> <span class="n">turn_by_turn_algo</span> <span class="o">==</span> <span class="s1">&#39;HA&#39;</span><span class="p">:</span>
        <span class="n">suffix_x</span> <span class="o">=</span> <span class="s1">&#39;_hax&#39;</span>
        <span class="n">suffix_y</span> <span class="o">=</span> <span class="s1">&#39;_hay&#39;</span>

    <span class="k">for</span> <span class="n">file_in</span> <span class="ow">in</span> <span class="n">files_to_analyse</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="c1"># x file</span>
        <span class="k">if</span> <span class="n">file_in</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
            <span class="n">file_x</span> <span class="o">=</span> <span class="n">file_in</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">,</span> <span class="n">suffix_x</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_x</span> <span class="o">=</span> <span class="n">file_in</span> <span class="o">+</span> <span class="n">suffix_x</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_x</span><span class="p">):</span>
                <span class="n">file_x</span> <span class="o">=</span> <span class="n">file_in</span> <span class="o">+</span> <span class="s1">&#39;.linx&#39;</span>

        <span class="n">twiss_file_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">twiss_file_x</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">has_no_bpm_data</span><span class="p">():</span>
                <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Ignoring empty file:&quot;</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">filename</span>
                <span class="n">twiss_file_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Cannot load file:&quot;</span><span class="p">,</span> <span class="n">file_x</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Information printed by metaclass already</span>

        <span class="k">if</span> <span class="kc">None</span> <span class="o">!=</span> <span class="n">twiss_file_x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_average</span><span class="p">:</span>
                <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">MUX</span> <span class="o">=</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">AVG_MUX</span>
            <span class="k">if</span> <span class="n">calibration_twiss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">AMPX</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">ERRAMPX</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">CALIBRATION</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">ERROR_CALIBRATION</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">NATURAL_TUNE</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">NATURAL_TUNE_RMS</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">TUNE</span><span class="p">,</span> <span class="n">twiss_file_x</span><span class="o">.</span><span class="n">TUNE_RMS</span> <span class="o">=</span> <span class="n">_get_calibrated_amplitudes</span><span class="p">(</span><span class="n">twiss_file_x</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dppi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">twiss_file_x</span><span class="p">,</span> <span class="s2">&quot;DPP&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">dppi</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dppi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
                <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;Warning: DPP may not be given as a number in &#39;</span><span class="p">,</span> <span class="n">file_x</span><span class="p">,</span> <span class="s1">&#39;...trying to forcibly cast it as a number&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dppi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dppi</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s1">&#39;dppi= &#39;</span><span class="p">,</span> <span class="n">dppi</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;but failing. DPP in &#39;</span><span class="p">,</span> <span class="n">file_x</span><span class="p">,</span> <span class="s1">&#39; is something wrong. String? --- leaving GetLLM&#39;</span>
                    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dppi</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getNDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nonlinear</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">rdt</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">resonant_driving_terms</span><span class="o">.</span><span class="n">RDT_LIST</span><span class="p">:</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="n">rdt</span><span class="o">+</span><span class="s1">&#39;_line.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="n">rdt</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;LHC&quot;</span> <span class="ow">in</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">:</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPx_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPy_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                        <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getIPfromphase_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetotx_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_in</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getNDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_x</span><span class="p">)</span>

        <span class="c1"># y file</span>
        <span class="k">if</span> <span class="n">file_in</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
            <span class="n">file_y</span> <span class="o">=</span> <span class="n">file_in</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">,</span> <span class="n">suffix_y</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_y</span> <span class="o">=</span> <span class="n">file_in</span> <span class="o">+</span> <span class="n">suffix_y</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_y</span><span class="p">):</span>
                <span class="n">file_y</span> <span class="o">=</span> <span class="n">file_in</span> <span class="o">+</span> <span class="s1">&#39;.liny&#39;</span>

        <span class="n">twiss_file_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">twiss_file_y</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">has_no_bpm_data</span><span class="p">():</span>
                <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Ignoring empty file:&quot;</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">filename</span>
                <span class="n">twiss_file_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Warning: There seems no &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; file in the specified directory.&#39;</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Information printed by metaclass already</span>

        <span class="k">if</span> <span class="kc">None</span> <span class="o">!=</span> <span class="n">twiss_file_y</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_average</span><span class="p">:</span>
                <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">MUY</span> <span class="o">=</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">AVG_MUY</span>
            <span class="k">if</span> <span class="n">calibration_twiss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">AMPY</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">ERRAMPY</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">CALIBRATION</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">ERROR_CALIBRATION</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">NATURAL_TUNE</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">NATURAL_TUNE_RMS</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">TUNE</span><span class="p">,</span> <span class="n">twiss_file_y</span><span class="o">.</span><span class="n">TUNE_RMS</span> <span class="o">=</span> <span class="n">_get_calibrated_amplitudes</span><span class="p">(</span><span class="n">twiss_file_y</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dppi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">twiss_file_y</span><span class="p">,</span> <span class="s2">&quot;DPP&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">dppi</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dppi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
                <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;Warning: DPP may not be given as a number in &#39;</span><span class="p">,</span> <span class="n">file_y</span><span class="p">,</span> <span class="s1">&#39;...trying to forcibly cast it as a number&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dppi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dppi</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="s1">&#39;dppi= &#39;</span><span class="p">,</span> <span class="n">dppi</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;but failing. DPP in &#39;</span><span class="p">,</span> <span class="n">file_y</span><span class="p">,</span> <span class="s1">&#39; is something wrong. String? --- leaving GetLLM&#39;</span>
                    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dppi</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOy.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDy.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasetoty_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
                    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file_y</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDy.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">file_y</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_zero_dpp_x</span><span class="p">():</span>
        <span class="nb">print</span> <span class="s1">&#39;Warning: you are running GetLLM without &quot;linx of dp/p=0&quot;. Are you sure?&#39;</span>

        <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_non_zero_dpp_x</span><span class="p">():</span>
            <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">=</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span>
            <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span> <span class="o">=</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span>
            <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="nb">print</span> <span class="s2">&quot;Previous warning suppressed, running in chromatic mode&quot;</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasex.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetax.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetax.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getNDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
                <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getcouple_free2.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getphasey.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getbetay.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getampbetay.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getDy.out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="s2">&quot;chrommode&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_no_input_files</span><span class="p">():</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;No parsed input files&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twiss_d</span><span class="p">,</span> <span class="n">files_dict</span>
<span class="c1"># END _analyse_src_files ----------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_check_bpm_compatibility</span><span class="p">(</span><span class="n">twiss_d</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks the monitor compatibility between data and model. If a monitor will not be found in the</span>
<span class="sd">    model, a message will be print to sys.stderr.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">all_twiss_files</span> <span class="o">=</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span>
    <span class="k">for</span> <span class="n">twiss_file</span> <span class="ow">in</span> <span class="n">all_twiss_files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bpm_name</span> <span class="ow">in</span> <span class="n">twiss_file</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mad_twiss</span><span class="o">.</span><span class="n">NAME</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bpm_name</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mad_twiss</span><span class="o">.</span><span class="n">NAME</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">bpm_name</span><span class="p">)]]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s1">&#39;Monitor &#39;</span> <span class="o">+</span> <span class="n">bpm_name</span> <span class="o">+</span> <span class="s1">&#39; cannot be found in the model!&#39;</span>


<span class="k">def</span> <span class="nf">_calculate_orbit</span><span class="p">(</span><span class="n">getllm_d</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">,</span> <span class="n">tune_d</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculates orbit and fills the following TfsFiles:</span>
<span class="sd">     - getCOx.out</span>
<span class="sd">     - getCOy.out</span>
<span class="sd">     - getCOx_dpp_&#39; + str(k + 1) + &#39;.out</span>
<span class="sd">     - getCOy_dpp_&#39; + str(k + 1) + &#39;.out</span>

<span class="sd">    :param _GetllmData getllm_d: accel is used(In-param, values will only be read)</span>
<span class="sd">    :param _TwissData twiss_d: Holds twiss instances of the src files. (In-param, values will only be read)</span>
<span class="sd">    :param _TuneData tune_d: Holds tunes and phase advances (In-param, values will only be read)</span>

<span class="sd">    :returns: (list, list, dict)</span>
<span class="sd">     - an list of dictionairies from horizontal computations</span>
<span class="sd">     - an list of dictionairies from vertical computations</span>
<span class="sd">     - the same dict as param files_dict to indicate that dict will be extended here.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Calculating orbit&#39;</span>
    <span class="n">list_of_co_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_zero_dpp_x</span><span class="p">():</span>
        <span class="p">[</span><span class="n">cox</span><span class="p">,</span> <span class="n">bpms</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">calculate_orbit</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">)</span>
        <span class="c1"># The output file can be directly used for orbit correction with MADX</span>
        <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOx.out&#39;</span><span class="p">]</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;TABLE&quot;</span><span class="p">,</span> <span class="s1">&#39;ORBIT&#39;</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="s1">&#39;ORBIT&#39;</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;SEQUENCE&quot;</span><span class="p">,</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q2&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q2</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">([</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;STDX&quot;</span><span class="p">,</span> <span class="s2">&quot;XMDL&quot;</span><span class="p">,</span> <span class="s2">&quot;MUXMDL&quot;</span><span class="p">])</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpms</span><span class="p">)):</span>
            <span class="n">bn1</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bns1</span> <span class="o">=</span> <span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">bn1</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">bns1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">),</span> <span class="n">cox</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cox</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">MUX</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]]]</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

        <span class="n">list_of_co_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cox</span><span class="p">)</span>
    <span class="n">list_of_co_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_zero_dpp_y</span><span class="p">():</span>
        <span class="p">[</span><span class="n">coy</span><span class="p">,</span> <span class="n">bpms</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">calculate_orbit</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">)</span>
        <span class="c1"># The output file can be directly used for orbit correction with MADX</span>
        <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getCOy.out&#39;</span><span class="p">]</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;TABLE&quot;</span><span class="p">,</span> <span class="s1">&#39;ORBIT&#39;</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="s1">&#39;ORBIT&#39;</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_string_descriptor</span><span class="p">(</span><span class="s2">&quot;SEQUENCE&quot;</span><span class="p">,</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q2&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q2</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">([</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;STDY&quot;</span><span class="p">,</span> <span class="s2">&quot;YMDL&quot;</span><span class="p">,</span> <span class="s2">&quot;MUYMDL&quot;</span><span class="p">])</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpms</span><span class="p">)):</span>
            <span class="n">bn1</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bns1</span> <span class="o">=</span> <span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">bn1</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">bns1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">),</span> <span class="n">coy</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coy</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">MUY</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]]]</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

        <span class="n">list_of_co_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coy</span><span class="p">)</span>
    <span class="c1">#-------- Orbit for non-zero DPP</span>
    <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_non_zero_dpp_x</span><span class="p">():</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">twiss_file</span> <span class="ow">in</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="p">:</span>
            <span class="n">list_with_single_twiss</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">list_with_single_twiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;getCOx_dpp_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">twiss_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;DPP&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">twiss_file</span><span class="o">.</span><span class="n">DPP</span><span class="p">))</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q2&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q2</span><span class="p">)</span>
            <span class="p">[</span><span class="n">codpp</span><span class="p">,</span> <span class="n">bpms</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">calculate_orbit</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">list_with_single_twiss</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">([</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;STDX&quot;</span><span class="p">,</span> <span class="s2">&quot;XMDL&quot;</span><span class="p">,</span> <span class="s2">&quot;MUXMDL&quot;</span><span class="p">])</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpms</span><span class="p">)):</span>
                <span class="n">bn1</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bns1</span> <span class="o">=</span> <span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">bn1</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">bns1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">),</span> <span class="n">codpp</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">codpp</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">MUX</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]]]</span>
                <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

            <span class="n">list_of_co_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codpp</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">has_non_zero_dpp_y</span><span class="p">():</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">twiss_file</span> <span class="ow">in</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="p">:</span>
            <span class="n">list_with_single_twiss</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">list_with_single_twiss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twiss_file</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;getCOy_dpp_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
            <span class="n">files_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetllmTfsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_filename_to_getllm_header</span><span class="p">(</span><span class="n">twiss_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;DPP&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">twiss_file</span><span class="o">.</span><span class="n">DPP</span><span class="p">))</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q1&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Q2&quot;</span><span class="p">,</span> <span class="n">tune_d</span><span class="o">.</span><span class="n">q2</span><span class="p">)</span>
            <span class="p">[</span><span class="n">codpp</span><span class="p">,</span> <span class="n">bpms</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">calculate_orbit</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">list_with_single_twiss</span><span class="p">)</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">([</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;STDY&quot;</span><span class="p">,</span> <span class="s2">&quot;YMDL&quot;</span><span class="p">,</span> <span class="s2">&quot;MUYMDL&quot;</span><span class="p">])</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bpms</span><span class="p">)):</span>
                <span class="n">bn1</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bns1</span> <span class="o">=</span> <span class="n">bpms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#TODO: why twiss_d.zero_dpp_y.. above used twiss_d.non_zero_dpp_y(vimaier)</span>
                <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">bn1</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">bns1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">),</span> <span class="n">codpp</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">codpp</span><span class="p">[</span><span class="n">bn1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]],</span> <span class="n">mad_twiss</span><span class="o">.</span><span class="n">MUY</span><span class="p">[</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bn1</span><span class="p">]]]</span>
                <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

            <span class="n">list_of_co_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codpp</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">list_of_co_x</span><span class="p">,</span> <span class="n">list_of_co_y</span><span class="p">,</span> <span class="n">files_dict</span>
<span class="c1"># END _calculate_orbit ------------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_calculate_getsextupoles</span><span class="p">(</span><span class="n">twiss_d</span><span class="p">,</span> <span class="n">phase_d</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">,</span> <span class="n">q1f</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fills the following TfsFiles:</span>
<span class="sd">     - getsex3000.out</span>

<span class="sd">    :returns: dict string --&gt; GetllmTfsFile -- The same instace of files_dict to indicate that the dict was extended.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Calculating getsextupoles&quot;</span>
    <span class="c1"># For getsex1200.out andgetsex2100.out take a look at older revisions. (vimaier)</span>

    <span class="n">htot</span><span class="p">,</span> <span class="n">afactor</span><span class="p">,</span> <span class="n">pfactor</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">Getsextupole</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">,</span> <span class="n">phase_d</span><span class="o">.</span><span class="n">ph_x</span><span class="p">,</span> <span class="n">q1f</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s2">&quot;getsex3000.out&quot;</span><span class="p">]</span>
    <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;f2h_factor&quot;</span><span class="p">,</span> <span class="n">afactor</span><span class="p">)</span>
    <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;p_f2h_factor&quot;</span><span class="p">,</span> <span class="n">pfactor</span><span class="p">)</span>
    <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">([</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;AMP_20&quot;</span><span class="p">,</span> <span class="s2">&quot;AMP_20std&quot;</span><span class="p">,</span> <span class="s2">&quot;PHASE_20&quot;</span><span class="p">,</span> <span class="s2">&quot;PHASE_20std&quot;</span><span class="p">,</span> <span class="s2">&quot;f3000&quot;</span><span class="p">,</span> <span class="s2">&quot;f3000std&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_f_3000&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_f_3000std&quot;</span><span class="p">,</span> <span class="s2">&quot;h3000&quot;</span><span class="p">,</span> <span class="s2">&quot;h3000_std&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_h_3000&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_h_3000_std&quot;</span><span class="p">])</span>
    <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">bpm_key</span> <span class="ow">in</span> <span class="n">htot</span><span class="p">:</span>
        <span class="n">li</span> <span class="o">=</span> <span class="n">htot</span><span class="p">[</span><span class="n">bpm_key</span><span class="p">]</span>
        <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">li</span><span class="p">[</span><span class="mi">13</span><span class="p">]]</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">files_dict</span>
<span class="c1"># END _calculate_getsextupoles ----------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_calculate_kick</span><span class="p">(</span><span class="n">kick_times</span><span class="p">,</span> <span class="n">getllm_d</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">,</span> <span class="n">phase_d</span><span class="p">,</span> <span class="n">beta_d</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">,</span> <span class="n">files_dict</span><span class="p">,</span> <span class="n">bbthreshold</span><span class="p">,</span> <span class="n">errthreshold</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fills the following TfsFiles:</span>
<span class="sd">     - getkick.out</span>
<span class="sd">     - getkickac.out</span>

<span class="sd">    :returns: dict string --&gt; GetllmTfsFile -- The same instace of files_dict to indicate that the dict was extended</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span> <span class="s2">&quot;Calculating kick&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="p">]</span>

    <span class="n">meansqrt_2jx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">meansqrt_2jy</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bpmrejx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bpmrejy</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="p">[</span><span class="n">tunes</span><span class="p">,</span> <span class="n">dpp</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">compensate_ac_effect</span><span class="o">.</span><span class="n">get_tunes</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">action_data_ac_dipole_phase_x</span><span class="p">,</span><span class="n">action_data_ac_dipole_model_x</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">get_action</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span><span class="n">beta_d</span><span class="o">.</span><span class="n">x_phase</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
    <span class="n">action_data_ac_dipole_phase_y</span><span class="p">,</span><span class="n">action_data_ac_dipole_model_y</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">get_action</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">mad_twiss</span><span class="p">,</span><span class="n">beta_d</span><span class="o">.</span><span class="n">y_phase</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
    <span class="n">tfs_file_model</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkick.out&#39;</span><span class="p">]</span>
    <span class="n">tfs_file_model</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="s2">&quot;Calculates the kick from the model beta function&quot;</span><span class="p">)</span>
    <span class="n">column_names_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;DPP&quot;</span><span class="p">,</span> <span class="s2">&quot;QX&quot;</span><span class="p">,</span> <span class="s2">&quot;QXRMS&quot;</span><span class="p">,</span> <span class="s2">&quot;QY&quot;</span><span class="p">,</span> <span class="s2">&quot;QYRMS&quot;</span><span class="p">,</span> <span class="s2">&quot;NATQX&quot;</span><span class="p">,</span> <span class="s2">&quot;NATQXRMS&quot;</span><span class="p">,</span> <span class="s2">&quot;NATQY&quot;</span><span class="p">,</span> <span class="s2">&quot;NATQYRMS&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JX&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JXSTD&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JY&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JYSTD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JX&quot;</span><span class="p">,</span> <span class="s2">&quot;2JXSTD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JY&quot;</span><span class="p">,</span> <span class="s2">&quot;2JYSTD&quot;</span><span class="p">]</span>
    <span class="n">column_types_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>     <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>      <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>    <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>      <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>      <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>        <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>       <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>    <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>   <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span>    <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">tfs_file_model</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">(</span><span class="n">column_names_list</span><span class="p">)</span>
    <span class="n">tfs_file_model</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">(</span><span class="n">column_types_list</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">kick_times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dpp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">tfs_file_model</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>
    <span class="n">actions_x</span><span class="p">,</span> <span class="n">actions_y</span> <span class="o">=</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">,</span><span class="n">action_data_ac_dipole_phase_y</span>

    <span class="n">tfs_file_phase</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkickphase.out&#39;</span><span class="p">]</span>
    <span class="n">tfs_file_phase</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Threshold_for_abs(beta_d-beta_m)/beta_m&quot;</span><span class="p">,</span> <span class="n">bbthreshold</span><span class="p">)</span>
    <span class="n">tfs_file_phase</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;Threshold_for_uncert(beta_d)/beta_d&quot;</span><span class="p">,</span> <span class="n">errthreshold</span><span class="p">)</span>
    <span class="n">tfs_file_phase</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">(</span><span class="n">column_names_list</span><span class="p">)</span>
    <span class="n">tfs_file_phase</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">(</span><span class="n">column_types_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpp</span><span class="p">)):</span>
        <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">kick_times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dpp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">tfs_file_phase</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">getllm_d</span><span class="o">.</span><span class="n">with_ac_calc</span><span class="p">:</span>
        <span class="n">action_data_ac_dipole_phase_x</span><span class="p">,</span><span class="n">action_data_ac_dipole_model_x</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">get_action</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">mad_ac</span><span class="p">,</span><span class="n">beta_d</span><span class="o">.</span><span class="n">x_phase_f</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
        <span class="n">action_data_ac_dipole_phase_y</span><span class="p">,</span><span class="n">action_data_ac_dipole_model_y</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">get_action</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">mad_ac</span><span class="p">,</span><span class="n">beta_d</span><span class="o">.</span><span class="n">y_phase_f</span><span class="p">,</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span> <span class="o">+</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">beam_direction</span><span class="p">,</span><span class="n">getllm_d</span><span class="o">.</span><span class="n">accel</span><span class="p">)</span>
        <span class="n">tfs_file</span> <span class="o">=</span> <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;getkickac.out&#39;</span><span class="p">]</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;RescalingFactor_for_X&quot;</span><span class="p">,</span> <span class="n">beta_d</span><span class="o">.</span><span class="n">x_ratio_f</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_float_descriptor</span><span class="p">(</span><span class="s2">&quot;RescalingFactor_for_Y&quot;</span><span class="p">,</span> <span class="n">beta_d</span><span class="o">.</span><span class="n">y_ratio_f</span><span class="p">)</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_names</span><span class="p">(</span><span class="n">column_names_list</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;sqrt2JXMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JXSTDMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JYMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt2JYSTDMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JXMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JXSTDMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JYMOD&quot;</span><span class="p">,</span> <span class="s2">&quot;2JYSTDMOD&quot;</span><span class="p">])</span>
        <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_column_datatypes</span><span class="p">(</span><span class="n">column_types_list</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%le</span><span class="s2">&quot;</span><span class="p">])</span>
        <span class="p">[</span><span class="n">tunes</span><span class="p">,</span> <span class="n">dpp</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">compensate_ac_effect</span><span class="o">.</span><span class="n">get_tunes</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpp</span><span class="p">)):</span>
            <span class="c1">#TODO: in table will be the ratio without f(beta_d.x_ratio) used but rescaling factor is f version(beta_d.x_ratio_f). Check it (vimaier)</span>
            <span class="n">list_row_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">kick_times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dpp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tunes</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_phase_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">action_data_ac_dipole_model_y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">tfs_file</span><span class="o">.</span><span class="n">add_table_row</span><span class="p">(</span><span class="n">list_row_entries</span><span class="p">)</span>
            <span class="n">actions_x</span><span class="p">,</span> <span class="n">actions_y</span> <span class="o">=</span> <span class="n">action_data_ac_dipole_phase_x</span><span class="p">,</span><span class="n">action_data_ac_dipole_phase_y</span>

    <span class="k">return</span> <span class="n">files_dict</span><span class="p">,</span> <span class="n">actions_x</span><span class="p">,</span> <span class="n">actions_y</span>
<span class="c1"># END _calculate_kick -------------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_get_calibrated_amplitudes</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span> <span class="n">calibration_twiss</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>
    <span class="n">calibration_file</span> <span class="o">=</span> <span class="n">calibration_twiss</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>
    <span class="n">cal_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">err_cal_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">calibration_value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">calibration_error</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
       <span class="n">tune</span> <span class="o">=</span> <span class="s2">&quot;Q1&quot;</span>
       <span class="n">tune_rms</span> <span class="o">=</span> <span class="s2">&quot;Q1RMS&quot;</span>
       <span class="n">natural_tune</span> <span class="o">=</span> <span class="s2">&quot;NATQ1&quot;</span>
       <span class="n">natural_tune_rms</span> <span class="o">=</span> <span class="s2">&quot;NATQ1RMS&quot;</span>
    <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
       <span class="n">tune</span> <span class="o">=</span> <span class="s2">&quot;Q2&quot;</span>
       <span class="n">tune_rms</span> <span class="o">=</span> <span class="s2">&quot;Q2RMS&quot;</span>
       <span class="n">natural_tune</span> <span class="o">=</span> <span class="s2">&quot;NATQ2&quot;</span>
       <span class="n">natural_tune_rms</span> <span class="o">=</span> <span class="s2">&quot;NATQ2RMS&quot;</span>
    <span class="n">tune_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span><span class="n">tune</span><span class="p">)</span>
    <span class="n">tune_value_rms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span><span class="n">tune_rms</span><span class="p">)</span>
    <span class="n">natural_tune_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span><span class="n">natural_tune_rms</span><span class="p">)</span>
    <span class="n">natural_tune_value_rms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span><span class="n">natural_tune_rms</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bpm_name</span> <span class="ow">in</span> <span class="n">drive_file</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
        <span class="n">drive_index</span> <span class="o">=</span> <span class="n">drive_file</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bpm_name</span><span class="p">]</span>
        <span class="n">cal_amplitude</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">drive_file</span><span class="p">,</span> <span class="s2">&quot;AMP&quot;</span> <span class="o">+</span> <span class="n">plane</span><span class="p">)[</span><span class="n">drive_index</span><span class="p">]</span>
        <span class="n">err_cal_amplitude</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">bpm_name</span> <span class="ow">in</span> <span class="n">calibration_file</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
            <span class="n">cal_index</span> <span class="o">=</span> <span class="n">calibration_file</span><span class="o">.</span><span class="n">indx</span><span class="p">[</span><span class="n">bpm_name</span><span class="p">]</span>
            <span class="n">cal_amplitude</span> <span class="o">=</span> <span class="n">cal_amplitude</span> <span class="o">*</span> <span class="n">calibration_file</span><span class="o">.</span><span class="n">CALIBRATION</span><span class="p">[</span><span class="n">cal_index</span><span class="p">]</span>
            <span class="n">err_cal_amplitude</span> <span class="o">=</span> <span class="n">cal_amplitude</span> <span class="o">*</span> <span class="n">calibration_file</span><span class="o">.</span><span class="n">ERROR_CALIBRATION</span><span class="p">[</span><span class="n">cal_index</span><span class="p">]</span>
            <span class="n">calibration_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_file</span><span class="o">.</span><span class="n">CALIBRATION</span><span class="p">[</span><span class="n">cal_index</span><span class="p">])</span>
            <span class="n">calibration_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_file</span><span class="o">.</span><span class="n">ERROR_CALIBRATION</span><span class="p">[</span><span class="n">cal_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calibration_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">calibration_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">cal_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cal_amplitude</span><span class="p">)</span>
        <span class="n">err_cal_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_cal_amplitude</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">cal_amplitudes</span><span class="p">),</span> <span class="n">array</span><span class="p">(</span><span class="n">err_cal_amplitudes</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">calibration_value</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">calibration_error</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">natural_tune_value</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">natural_tune_value_rms</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">tune_value</span><span class="p">),</span><span class="n">array</span><span class="p">(</span><span class="n">tune_value_rms</span><span class="p">)</span>
<span class="c1"># END _get_calibrated_amplitudes --------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_copy_calibration_files</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">calibration_dir_path</span><span class="p">):</span>
    <span class="n">calibration_twiss</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">calibration_dir_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">original_cal_file_path_x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calibration_dir_path</span><span class="p">,</span> <span class="s2">&quot;calibration_x.out&quot;</span><span class="p">)</span>
        <span class="n">original_cal_file_path_y</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calibration_dir_path</span><span class="p">,</span> <span class="s2">&quot;calibration_y.out&quot;</span><span class="p">)</span>
        <span class="n">cal_file_path_x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;calibration_x.out&quot;</span><span class="p">)</span>
        <span class="n">cal_file_path_y</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;calibration_y.out&quot;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">iotools</span><span class="o">.</span><span class="n">copy_item</span><span class="p">(</span><span class="n">original_cal_file_path_x</span><span class="p">,</span> <span class="n">cal_file_path_x</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">iotools</span><span class="o">.</span><span class="n">copy_item</span><span class="p">(</span><span class="n">original_cal_file_path_y</span><span class="p">,</span> <span class="n">cal_file_path_y</span><span class="p">)</span>

        <span class="n">calibration_twiss</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">cal_file_path_x</span><span class="p">)</span>
        <span class="n">calibration_twiss</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Python_Classes4MAD</span><span class="o">.</span><span class="n">metaclass</span><span class="o">.</span><span class="n">twiss</span><span class="p">(</span><span class="n">cal_file_path_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calibration_twiss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
<span class="c1"># END _copy_calibration_files --------------------------------------------------------------------</span>


<span class="c1">#===================================================================================================</span>
<span class="c1"># helper classes for data structures</span>
<span class="c1">#===================================================================================================</span>
<span class="k">class</span> <span class="nc">_GetllmData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Holds some data from parameters of main function. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Constructor&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputpath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_input_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_direction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhc_phase</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpm_unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut_for_closed_orbit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_bpms_for_coupling</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">use_only_three_bpms_for_beta_from_phase</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_bpms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_of_bpms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errordefspath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprocesses</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onlycoupling</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_ac_calc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acdipole</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">important_pairs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set_outputpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputpath</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Sets the outputpath and creates directories if they not exist.</span>

<span class="sd">        :param string outputpath: Path to output dir. If dir(s) to output do(es) not exist, it/they will be created.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">iotools</span><span class="o">.</span><span class="n">create_dirs</span><span class="p">(</span><span class="n">outputpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputpath</span> <span class="o">=</span> <span class="n">outputpath</span>

    <span class="k">def</span> <span class="nf">set_bpmu_and_cut_for_closed_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut_co</span><span class="p">,</span> <span class="n">bpm_unit</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculates and sets the cut and bpm unit.</span>
<span class="sd">        :param int cut_co: Cut in um(micrometer).</span>
<span class="sd">        :param string bpm_unit: Indicates used unit. um, mm, cm or m</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpm_unit</span> <span class="o">=</span> <span class="n">bpm_unit</span>

        <span class="k">if</span> <span class="n">bpm_unit</span> <span class="o">==</span> <span class="s1">&#39;um&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cut_for_closed_orbit</span> <span class="o">=</span> <span class="n">cut_co</span>
        <span class="k">elif</span> <span class="n">bpm_unit</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cut_for_closed_orbit</span> <span class="o">=</span> <span class="n">cut_co</span> <span class="o">/</span> <span class="mf">1.0e3</span>
        <span class="k">elif</span> <span class="n">bpm_unit</span> <span class="o">==</span> <span class="s1">&#39;cm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cut_for_closed_orbit</span> <span class="o">=</span> <span class="n">cut_co</span> <span class="o">/</span> <span class="mf">1.0e4</span>
        <span class="k">elif</span> <span class="n">bpm_unit</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cut_for_closed_orbit</span> <span class="o">=</span> <span class="n">cut_co</span> <span class="o">/</span> <span class="mf">1.0e6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;Wrong BPM unit:&quot;</span><span class="p">,</span> <span class="n">bpm_unit</span>


<span class="k">class</span> <span class="nc">_TwissData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Holds twiss instances of all src files. &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Constructor&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_dpp_x</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of src files which have dpp==0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_dpp_x</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of src files which have dpp!=0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_dpp_y</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of src files which have dpp==0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_dpp_y</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of src files which have dpp!=0.0      </span>

    <span class="k">def</span> <span class="nf">has_zero_dpp_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns True if _linx file(s) exist(s) with dpp==0 &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_non_zero_dpp_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns True if _linx file(s) exist(s) with dpp!=0 &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_zero_dpp_x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_zero_dpp_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns True if _liny file(s) exist(s) with dpp==0 &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_non_zero_dpp_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns True if _liny file(s) exist(s) with dpp!=0 &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_zero_dpp_y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">has_no_input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_zero_dpp_x</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_zero_dpp_y</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_non_zero_dpp_x</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_non_zero_dpp_y</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_TuneData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Used as data structure to hold tunes and phase advances. &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Constructor&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Driven horizontal tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Driven vertical tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mux</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Driven horizontal phase advance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muy</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Driven vertical phase advance</span>

        <span class="c1"># Free is from analytic equation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1f</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free horizontal tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2f</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free vertical tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muxf</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free horizontal phase advance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muyf</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free vertical phase advance</span>

        <span class="c1"># Free2 is using the effective model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muxf2</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free2 horizontal phase advance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">muyf2</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Free2 vertical phase advance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta1</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Used later to calculate free Q1. Only if with ac calculation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta2</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Used later to calculate free Q2. Only if with ac calculation.</span>

    <span class="k">def</span> <span class="nf">initialize_tunes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_ac_calc</span><span class="p">,</span> <span class="n">mad_twiss</span><span class="p">,</span> <span class="n">mad_ac</span><span class="p">,</span> <span class="n">twiss_d</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculates and sets the initial tunes. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">with_ac_calc</span><span class="p">:</span>
            <span class="c1"># Get fractional part: frac(62.23) = 0.23; 62.23 % 1 ==&gt; 0.23 (vimaier)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q1f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">Q1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span>  <span class="c1"># -- Free Q1 (tempolarlly, overwritten later)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q2f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mad_twiss</span><span class="o">.</span><span class="n">Q2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span>  <span class="c1"># -- Free Q2 (tempolarlly, overwritten later)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mad_ac</span><span class="o">.</span><span class="n">Q1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span>  <span class="c1"># -- Drive Q1 (tempolarlly, overwritten later)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mad_ac</span><span class="o">.</span><span class="n">Q2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1</span>  <span class="c1"># -- Drive Q2 (tempolarlly, overwritten later)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1f</span>  <span class="c1"># -- Used later to calculate free Q1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2f</span>  <span class="c1"># -- Used later to calculate free Q2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">q1f</span> <span class="o">=</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Q1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">q2f</span> <span class="o">=</span> <span class="n">twiss_d</span><span class="o">.</span><span class="n">zero_dpp_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Q2</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_disable_these_loggers</span><span class="p">():</span>
    <span class="c1"># Disable</span>
    <span class="n">logging_tools</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tfs_files.tfs_file_writer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging_tools</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="c1">#===================================================================================================</span>
<span class="c1"># main invocation</span>
<span class="c1">#===================================================================================================</span>


<span class="k">def</span> <span class="nf">_start</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Starter function to avoid polluting global namespace with variables options,args.</span>
<span class="sd">    Before the following code was after &#39;if __name__==&quot;__main__&quot;:&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">_parse_args</span><span class="p">()</span>
    <span class="n">main</span><span class="p">(</span><span class="n">outputpath</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
         <span class="n">dict_file</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span>
         <span class="n">files_to_analyse</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">files</span><span class="p">,</span>
         <span class="n">model_filename</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">Twiss</span><span class="p">,</span>
         <span class="n">accel</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">ACCEL</span><span class="p">,</span>
         <span class="n">lhcphase</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">lhcphase</span><span class="p">,</span>
         <span class="n">bpmu</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">BPMUNIT</span><span class="p">,</span>
         <span class="n">cocut</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">COcut</span><span class="p">),</span>
         <span class="n">nbcpl</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">NBcpl</span><span class="p">),</span>
         <span class="n">nonlinear</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">nonlinear</span><span class="p">,</span>
         <span class="n">tbtana</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">TBTana</span><span class="p">,</span>
         <span class="n">bbthreshold</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">bbthreshold</span><span class="p">,</span>
         <span class="n">errthreshold</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">errthreshold</span><span class="p">,</span>
         <span class="n">use_only_three_bpms_for_beta_from_phase</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">use_only_three_bpms_for_beta_from_phase</span><span class="p">,</span>
         <span class="n">number_of_bpms</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">number_of_bpms</span><span class="p">,</span>
         <span class="n">range_of_bpms</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">range_of_bpms</span><span class="p">,</span>
         <span class="n">use_average</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">use_average</span><span class="p">,</span>
         <span class="n">calibration_dir_path</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">calibration_dir_path</span><span class="p">,</span>
         <span class="n">errordefspath</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">errordefspath</span><span class="p">,</span>
         <span class="n">nprocesses</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">nprocesses</span><span class="p">,</span>
         <span class="n">onlycoupling</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">onlycoupling</span><span class="p">,</span>
         <span class="n">use_error_of_mean</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">use_error_of_mean</span><span class="p">)</span>
     
     
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># This is to enable debug to GetLLM.log file only if sys.flags.debug is True</span>
    <span class="k">with</span> <span class="n">logging_tools</span><span class="o">.</span><span class="n">DebugMode</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;GetLLM.log&quot;</span><span class="p">,</span><span class="n">add_date_to_fname</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">dm</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dm</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="c1">#disable DEBUG level on the console (== INFO and above to console)</span>
            <span class="n">dm</span><span class="o">.</span><span class="n">console_h</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging_tools</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The command: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

        <span class="n">_disable_these_loggers</span><span class="p">()</span>

        <span class="n">_start</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018, OMC-TEAM.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>